trigger:
  branches:
    include:
      - main

pr:
  branches:
    include:
      - main

variables:
  - group: TerraformSecrets  # Reference stored secrets in ADO

stages:
  - stage: Terraform_Deployment
    displayName: "Terraform Deployment"
    jobs:
      - job: Terraform_Deploy
        displayName: "Deploy Terraform"
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          # Install Terraform
          - task: TerraformInstaller@1
            displayName: "Install Terraform"
            inputs:
              terraformVersion: '1.9.2'

          # Azure CLI Login
          - task: AzureCLI@2
            displayName: "Azure Login"
            inputs:
              azureSubscription: "Terraform Deployment Connection"  # Service connection name
              scriptType: "bash"
              scriptLocation: "inlineScript"
              inlineScript: |
                echo "Logged into Azure"

          # Terraform Init
          - script: terraform init
            displayName: "Terraform Init"
            env:
              ARM_USE_OIDC: true
              ARM_CLIENT_ID: $(AZURE_CLIENT_ID)
              ARM_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(AZURE_TENANT_ID)

          # Terraform Plan
          - script: terraform plan -out=tfplan
            displayName: "Terraform Plan"
            env:
              ARM_USE_OIDC: true
              ARM_CLIENT_ID: $(AZURE_CLIENT_ID)
              ARM_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(AZURE_TENANT_ID)

          # Terraform Apply (only on main branch)
          - script: terraform apply -auto-approve tfplan
            displayName: "Terraform Apply"
            condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')
            env:
              ARM_USE_OIDC: true
              ARM_CLIENT_ID: $(AZURE_CLIENT_ID)
              ARM_SUBSCRIPTION_ID: $(AZURE_SUBSCRIPTION_ID)
              ARM_TENANT_ID: $(AZURE_TENANT_ID)
